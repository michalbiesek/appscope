# JSON Schema

This directory contains JSON schema for each metrics and events generated by the AppScope.

## Table of contents
* [Working with the JSON schema](#working-with-the-JSON-schema)
  * [Event](#event)
  * [Metric](#metric)
* [Validation](#validation)
* [Resolve $ref pointers](#resolve-$ref-pointers)
* [Document generation](#doc-generation)

## Working with the JSON schema

JSON Schema is a vocabulary taht allows to annotate and validate JSON documents.
More information can be founded [here](https://json-schema.org/) here.
In Appscope we use it to describe the metrics and events generated by the AppScope. 

### Event

To add new event `foo.bar` please create file `event_foo_bar.schema.json`

- `root` section required update of `"$id"` and `"description"` fields
- `body` section required update value of following `$ref` in properties in `"sourcetype` and `"source"`
- `data` section required update of expected `properties` which will be in `data` section of event, in
  template below - example `properties` are presented as `property_name_1` and `property_name_2`. `required`
  section should be updated accordingly.

```
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://appscope.dev/docs/schemas/event_foo_bar.schema.json",
  "type": "object",
  "title": "AppScope Event",
  "description": "A structure described AppScope foo.bar event message",
  "required": [
    "type",
    "id",
    "_channel",
    "body"
  ],
  "properties": {
    "type": {
      "$ref": "definitions/metadata.schema.json#/$defs/event_type"
    },
    "id": {
      "$ref": "definitions/metadata.schema.json#/$defs/id"
    },
    "_channel": {
      "$ref": "definitions/metadata.schema.json#/$defs/_channel"
    },
    "body": {
      "title": "body",
      "description": "body",
      "type": "object",
      "required": [
        "sourcetype",
        "_time",
        "source",
        "host",
        "proc",
        "cmd",
        "pid",
        "data"
      ],
      "properties": {
        "sourcetype": {
          "$ref": "definitions/body.schema.json#/$defs/sourcetypefootype"
        },
        "_time": {
          "$ref": "definitions/body.schema.json#/$defs/_time"
        },
        "source": {
          "$ref": "definitions/body.schema.json#/$defs/sourcefoobar"
        },
        "host": {
          "$ref": "definitions/data.schema.json#/$defs/host"
        },
        "proc": {
          "$ref": "definitions/data.schema.json#/$defs/proc"
        },
        "cmd": {
          "$ref": "definitions/body.schema.json#/$defs/cmd"
        },
        "pid": {
          "$ref": "definitions/data.schema.json#/$defs/pid"
        },
        "data": {
          "title": "data",
          "description": "data",
          "type": "object",
          "required": [
            "property_name_1",
            "property_name_2"
          ],
          "properties": {
            "property_name_1": {
              "$ref": "definitions/data.schema.json#/$defs/property_name_1"
            },
            "property_name_2": {
              "$ref": "definitions/data.schema.json#/$defs/property_name_2"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}

```

### Metric

To add new metric `foo.bar` please create file `metric_foo_bar.schema.json`

- `root` section required update of `"$id"` and `"description"` fields
- `body` section required update value of following `$ref` in properties in `"_metric` and `"_metric_type"`
- `body` section required update of expected `properties` which will be in `body` section of metrics, in
  template below - example `properties` is presented as `property_name_1`. `required`
  section should be updated accordingly.

```
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://appscope.dev/docs/schemas/metric_foo_bar.schema.json",
  "type": "object",
  "title": "AppScope Metric",
  "description": "A structure described AppScope foo.bar metric message",
  "required": [
    "type",
    "body"
  ],
  "properties": {
    "type": {
      "$ref": "definitions/metadata.schema.json#/$defs/metric_type"
    },
    "body": {
      "title": "body",
      "description": "body",
      "type": "object",
      "required": [
        "_metric",
        "_metric_type",
        "_value",
        "property_name_1",
        "_time"
      ],
      "properties": {
        "_metric": {
          "$ref": "definitions/body.schema.json#/$defs/sourcefoobar"
        },
        "_metric_type": {
          "$ref": "definitions/body.schema.json#/$defs/metric_type_foo"
        },
        "_value": {
          "$ref": "definitions/body.schema.json#/$defs/_value"
        },
        "property_name_1": {
          "$ref": "definitions/body.schema.json#/$defs/property_name_1"
        },
        "_time": {
          "$ref": "definitions/body.schema.json#/$defs/_time"
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}

```

## Validation

## Resolve $ref pointers

```
json-dereference -s input.schema.json -o resolved.schema.json
```

## Document generation